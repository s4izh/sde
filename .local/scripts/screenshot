#!/bin/bash

# dependencies: file, notify-send
# - wayland: grim, slurp, wl-copy, wl-paste
# - xorg: maim, xclip

SCREENSHOT_DIR="$HOME/pix/screenshots"
FILE=$(date +'%Y%m%d_%H%M%S').png
SCREENSHOT_PATH=$SCREENSHOT_DIR/$FILE

if [ ! -d $SCREENSHOT_DIR ]; then
    mkdir -p $SCREENSHOT_DIR
fi

function send_notification {
    notify-send "Screenshot saved" "$SCREENSHOT_PATH" -i $SCREENSHOT_PATH
    # notify-send.sh "Screenshot saved" "$SCREENSHOT_PATH" -i $SCREENSHOT_PATH -d "feh $SCREENSHOT_PATH"
}

function xorg_screenshot() {
    maim -s | tee $SCREENSHOT_PATH | xclip -selection clipboard -t image/png

  # i dont know how to make this better
  # img=$(maim -s) and checking if $img is empty doesnt work
  #

  if $(file $SCREENSHOT_PATH | grep -qs "empty"); then
      rm $SCREENSHOT_PATH
  else
      send_notification
  fi
}

function wayland_screenshot() {
    if [ "$1" == "area" ]; then
        slurpout=$(slurp)
        if [ -z "$slurpout" ]; then
            exit
        else
            grim -g "$slurpout" - | wl-copy --type image/png && wl-paste > $SCREENSHOT_PATH
            send_notification
        fi
    fi
}

function _screenshot() {
    case $XDG_SESSION_TYPE in
        wayland)
            wayland_screenshot
            ;;
        xorg|*)
            xorg_screenshot
            ;;
    esac
}

if [ -z "$1" ]; then
    _screenshot
    exit
else
    for i in "$@"; do
        case $i in
            --name-prompt|-n)
                name=$(echo "" | dmenu -p "screenshot name:")
                if [ -z "$name" ]; then
                    exit
                fi
                FILE=$name.png
                shift
                ;;
            --dir=*)
                SCREENSHOT_DIR="${i#*=}"
                shift
                ;;
            --name=*)
                FILE="${i#*=}"
                shift
                ;;
            -*|--*)
                echo "Unknown option $i"
                exit 1
                ;;
            *)
                exit
                ;;
        esac
    done

    SCREENSHOT_PATH=$SCREENSHOT_DIR/$FILE
    _screenshot
fi
